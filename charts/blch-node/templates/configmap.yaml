apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config-overlay
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "blch-node.labels" . | nindent 4 }}
data:
  config-overlay.toml: |
    {{- if eq .Values.blch.nodeType "sentry" }}
    priv_validator_laddr = "tcp://0.0.0.0:1234"
    {{- end }}
    [rpc]
    laddr = "tcp://0.0.0.0:{{ .Values.service.ports.rpc.containerPort }}"
    {{- if .Values.blch.config }}
    {{- if .Values.blch.config.externalAddress }}
    [p2p]
    external_address = "{{ .Values.blch.config.externalAddress }}:{{ .Values.service.p2p.port }}"
    {{- end }}
    {{- if .Values.blch.config.seeds }}
    seeds = {{ .Values.blch.config.seeds | quote }}
    {{- end }}
    {{- if .Values.blch.config.peers }}
    peers = {{ .Values.blch.config.peers | quote }}
    {{- end }}
    {{- if .Values.blch.config.kvIndexerEnabled }}
    [tx_index]
    indexer = "kv"
    {{- end }}
    {{- if .Values.blch.config.overrides }}
    {{- .Values.blch.config.overrides | toYaml | nindent 4 }}
    {{- end }}
    {{- end }}
  app-overlay.toml: |
    minimum-gas-prices = {{ .Values.blch.minGasPrice | quote }}
    [grpc]
    address = "0.0.0.0:{{ .Values.service.ports.grpc.containerPort }}"
    [api]
    address = "tcp://0.0.0.0:{{ .Values.service.ports.rest.containerPort }}"
    enable  = true
    [json-rpc]
    ws-address = "0.0.0.0:{{ .Values.service.ports.ws.containerPort }}"
    {{- if .Values.blch.pruning }}
    pruning-strategy = {{ .Values.blch.pruning.strategy | default "custom" | quote }}
    pruning-keep-recent = {{ .Values.blch.pruning.keepRecent | default 100 | quote }}
    pruning-interval = {{ .Values.blch.pruning.interval | default 10 | quote }}
    {{- if .Values.blch.pruning.keepEvery }}
    pruning-keep-every = {{ .Values.blch.pruning.keepEvery | quote }}
    {{- end }}
    {{- end }}
    {{- if .Values.blch.appOverrides }}
    {{- .Values.blch.appOverrides | toYaml | nindent 4 }}
    {{- end }}
